api-version: reviewpad.com/v2.x

# edition can be team (open-source built-ins) or professional (all available built-ins)
edition: professional

# mode can be either silent (no explanation) or verbose
mode: verbose

# labels specifies a map of labels that will be created in the GitHub repository 
# if they do not already exist
labels:
  # the key is the name of the label
  critical-code:
    description: label critical code
    # color is the hexadecimal color code for the label, without the leading #
    color: "8a2140"

  do-not-merge:
    description: label pull requests that should not be merged
    color: "294b65"

  small:
    description: small changes
    # color is the hexadecimal color code for the label, without the leading #.
    color: "294b69"

  medium:
    description: medium changes
    color: "a8c3f7"

  large:
    description: label large pull requests
    color: "8b2120"

  lint-failed:
    description: label pull requests which are not properly formatted
    color: "8b2122"

  rand-api:
    description: label pull requests that change calls to the random api
    color: "8a2200"

  ship:
    description: label with ship pull requests which are automatically merged
    color: "76dbbe"

  unauthorized:
    description: label pull requests that make unauthorized modifications
    color: "8a2200"

# groups specifies a set of groups that can be used in the rules and workflows
# there are two types of groups: static and dynamic, e.g. 'owners' is a static group
# and 'rising-stars' is a dynamic group
groups:
  # this group is a list of logins in GitHub and can be accessed 
  # via the $group() built-in, e.g. $group("owners")
  - name: owners
    description: Group of owners
    kind: developers
    # the spec of a group is an Aladino expression that evaluates to a list of strings
    # you can directly specify the group with the list notation
    spec: '["marcelosousa"]'

  - name: seniors
    description: Group of senior developers
    kind: developers
    spec: '["ferreiratiago"]'

  - name: security-team
    description: Security team
    kind: developers
    spec: '["marcelosousa", "explore-dev-team"]'

  - name: owners-and-seniors
    description: Group of owners and senior developers
    kind: developers
    # some groups can be defined using other groups
    spec: '$append($group("owners"), $group("seniors"))'

  - name: rising-stars
    description: Group of developers with < 10 pull requests
    kind: developers
    # to define a dynamic group (of developers)
    # we use the type 'filter'
    type: filter
    # define a name to the parameter
    param: dev
    # the where property is a boolean expression that can 
    # now use the param 'dev' as an aladino variable '$dev'
    where: $totalCreatedPullRequests($dev) < 10

# rules specifies a set of rules over pull requests to be used in the workflows
rules:
  - name: authored-by-rising-stars
    kind: patch
    description: Pull request was authored by a rising star
    # the spec of a rule is a boolean Aladino expression
    spec: $isElementOf($author(), $group("rising-stars"))

  - name: authored-by-owners-or-seniors
    kind: patch
    description: Pull request was authored by senior or owner
    spec: $isElementOf($author(), $group("owners-and-seniors"))

  - name: bug-fix-with-wrong-head-branch
    kind: patch
    description: The head branch of a bug fix should start with fix
    # rules can be used in the definition of other rules via the $rule() built-in
    spec: '$rule("is-bug-fix") && !$contains($head(), "fix/")'

  - name: bug-fix-without-linked-issue
    kind: patch
    description: Bug fix without linked issue
    spec: '$rule("is-bug-fix") && !$hasLinkedIssues()'

  - name: changes-critical-functions
    kind: patch
    description: Changes to functions considered critical 
    # This spec uses a special built-in that understand which functions were commented
    # with "reviewpad-an: critical"
    spec: '$hasAnnotation("critical")'

  - name: change-freeze
    kind: patch
    description: Change freeze is happening
    # you can also use timestamps in the rule specification:
    # https://docs.reviewpad.com/docs/timestamps
    spec: '$createdAt() >= 2022-06-20'

  - name: changes-to-code-in-tests
    kind: patch
    description: Check if changes in the source files also occur in the tests files
    spec: '!$changed("go/@1.go", "go/@1_test.go")'

  - name: changes-to-main-file
    description: Changes to the main file
    kind: patch
    spec: '$hasFileName("go/main.go")'

  - name: changes-to-md-files
    kind: patch
    description: Patch only contains changes to files with extension .md
    spec: $hasFileExtensions([".md"])
  
  - name: commit-count-is-high
    kind: patch
    description: Check if the pull request has more than 5 commits
    spec: '$commitCount() > 5'

  - name: does-not-have-linear-history
    kind: patch
    description: Pull request does not have a linear history
    spec: '!$hasLinearHistory()'

  - name: empty-description
    kind: patch
    description: Pull request has an empty description
    spec: '$title() == ""'

  - name: is-bug-fix
    kind: patch
    description: Bug fix
    spec: '$contains($title(), "bug:") || $isElementOf("bug", $labels())'

  - name: is-large-pull-request
    kind: patch
    description: Pull request is very large
    spec: '$size() > 1000 && $fileCount() > 20'

  - name: is-medium
    kind: patch
    description: Pull request is medium
    spec: '$size() > 30 && $size() < 300'

  - name: is-small
    kind: patch
    description: Pull request is small
    spec: '$size() <= 30'

  - name: protect-rand-api
    kind: patch
    description: Changes to the rand API
    spec: '$hasCodePattern("rand.*")'

  - name: ship-condition
    description: Ship rule for pull requests
    kind: patch
    spec: '$rule("changes-to-md-files") && $rule("authored-by-owners-or-seniors")'

  - name: unauthorized-changes-to-reviewpad
    description: Unauthorized changes to the reviewpad.yml file
    kind: patch
    spec: '$hasFileName("reviewpad.yml") && !$isElementOf($author(), $group("owners"))'

# workflows specifies a list of workflows; it is a list because the order of 
# execution matters.
workflows:
  - name: lint-workflow
    description: Lint the pull request
    # always-run is a boolean property to control if this workflow should always be executed
    always-run: true
    if:
      - rule: empty-description
        # if 'empty-description' is true, the 'extra-actions' property will be 
        # executed after the main actions
        extra-actions:
          - '$error("Pull request has an empty description.")'
      - rule: is-bug-fix
        extra-actions:
          - '$addLabel("bug")'
      - rule: bug-fix-without-linked-issue
        extra-actions:
          - '$error("Bug fixes should have a linked issue")'
      - rule: bug-fix-with-wrong-head-branch
        extra-actions:
          - '$error("Bug fixes should be done in a branch starting with fix/")'
      - rule: commit-count-is-high
        extra-actions:
          - '$info("Every pull request should not have more than 2 commits. this pull request has more than 5!")'
      - rule: does-not-have-linear-history
        extra-actions:
          - '$info("This pull does not seem to have a linear history.")'
    then:
      - '$addLabel("lint-failed")'

  - name: label-pull-request-with-size
    description: Label pull request with size
    always-run: true
    if:
      - rule: isSmall
        extra-actions:
          - $addLabel("small")
      - rule: isMedium
        extra-actions: 
          - $addLabel("medium")
      - rule: is-large-pull-request
        extra-actions:
          - '$warn("This pull request is very large which will make it specially hard to review.")'
          - '$addLabel("large")'

  - name: docs-workflow
    description: Changes to the documentation
    always-run: true
    if:
      - rule: changes-to-md-files
    then:
      - '$info("@adrianoapmartins: there were some changes to the docs. can you take a look?")'

  - name: unauthorized-modifications
    description: Protect unauthorized modifications
    if:
      - rule: unauthorized-changes-to-reviewpad
    then:
      - '$addLabel("unauthorized")'
      - '$comment("This pull request makes unauthorized modifications. it will be automatically closed")'
      - '$close()'

  - name: ask-mode
    description: Changes which require a careful review
    always-run: true
    if:
      - rule: changes-to-main-file
        extra-actions:
          - '$warn("@marcelosousa: please review the change to go/main.go")'
      - rule: changes-critical-functions
        extra-actions:
          - '$info("You have modified code that requires a security review.")'
          - '$assignReviewer($group("security-team"))'
    then:
      - '$addLabel("critical-code")'

  - name: protect-rand-api
    description: Protect calls to the Random API
    always-run: true
    if:
      - rule: protect-rand-api
    then:
      - '$warn("Looks like you have changed a call to the rand API. this will trigger a different review process")'
      - '$addLabel("rand-api")'
      - '$assignReviewer($group("seniors"))'
  
  - name: change-freeze
    description: Change freeze
    always-run: true
    if:
      - rule: change-freeze
    then:
      - '$addLabel("do-not-merge")'

  - name: test-changes
    description: Warn of missing changes in the tests
    always-run: true
    if:
      - rule: changes-to-code-in-tests
    then:
      - '$warn("Looks like you might be missing changes to some test files.")'

  - name: mentor-rising-stars
    description: Mentors rising stars
    always-run: true
    if:
      - rule: authored-by-rising-stars
    then:
      - '$info("Thank you for this pull request!")'
      # Assign another rising star and a senior to review this pull request
      - '$assignReviewer($group("rising-stars"), 1)'
      - '$assignReviewer($group("seniors"), 1)'

  - name: ship
    description: Smart merge certain pull requests
    if:
      - rule: ship-condition
    then:
      - '$addLabel("ship")'
      # Check out the parameters for the merge built-in at: 
      #    https://docs.reviewpad.com/docs/aladino-builtins#merge
      - '$merge()'

  - name: review-of-seniors
    description: Senior reviews have a lightweight review process
    if:
      - rule: authored-by-owners-or-seniors
    then:
      - '$assignRandomReviewer()'
